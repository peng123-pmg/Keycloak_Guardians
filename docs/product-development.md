# 产品开发文档

## 产品概述

- 目标：提供基于 Keycloak 认证的团队文件协作与共享能力，统一用户与访问控制。
- 主要用户：企业团队成员、团队管理员、平台管理员。
- 关键价值：安全的身份与权限、个人/团队文件共享、通知与审计、快速集成。

## 技术架构概览

```
┌──────────────────────────────────────────────────────────────┐
│                    Keycloak Guardians 架构                   │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  浏览器/前端 (Theme, Vite/React)                             │
│             │ OIDC/OAuth2                                    │
│             ▼                                                │
│       ┌────────────────┐   SPI/主题   ┌────────────────────┐ │
│       │   Keycloak     │◄────────────▶│ 自定义主题/扩展    │ │
│       │ (Auth Server)  │              │ (登录/账户界面)    │ │
│       └────────────────┘              └────────────────────┘ │
│             │ Token 校验                                     │
│             ▼                                                │
│       ┌────────────────┐  REST API   ┌────────────────────┐ │
│       │ Quarkus 后端   │◄────────────▶│ 业务前端/控制台*   │ │
│       │ (keycloak-     │              │ (可选)            │ │
│       │ server)        │              └────────────────────┘ │
│       ├────────┬───────┤                                     │
│       │  DB    │ 对象存储/文件系统                           │
│       └────────┴───────┘                                     │
│        监控/日志/告警 & CI/CD                                │
└──────────────────────────────────────────────────────────────┘
* 若启用独立管理控制台/admin-console。
```

- 若有需要，可在 docs/diagram/ 放置正式的 PNG/SVG 架构图（示例文件名：docs/diagram/architecture.png）并在此引用。
- 组件分层：
	- 身份与认证：Keycloak（OIDC/OAuth2），承担登录、Token、角色/组管理。
	- 后端服务：Quarkus + Kotlin（模块 keycloak-server），提供 REST API、业务逻辑、权限校验。
	- 存储层：关系型数据库（如 PostgreSQL）保存元数据；对象存储/文件系统保存实际文件内容。
	- 前端：Vite + TypeScript + React（目录 Theme/），用于 Keycloak 主题与业务前端页面；若启用 admin-console 作为独立管理界面则通过 REST 调用后端。
	- 运维与交付：Gradle 8 构建，容器化/云部署（可接入 CI/CD），监控与日志采集。

## 技术栈与基础设施

- 语言/框架：Kotlin 1.x、Quarkus 3.x、Vite + React + TypeScript。
- 身份管理：Keycloak（组、角色、Token、会话管理）。
- 构建工具：Gradle 8（keycloak-server/gradlew.bat | gradlew）。
- 运行环境：Java 17+，本地默认端口 8081（按 Postman 集合示例），可通过 application.properties 调整。
- 依赖服务：数据库（PostgreSQL/MySQL 任选其一，需对应驱动）、对象存储（本地磁盘或云存储）。

## 模块职责

- 身份与用户：登录、Token 刷新、角色与权限、密码与会话管理（交由 Keycloak）。
- 小组/团队：创建、删除（仅创建者）、成员列表、邀请成员、角色管理（OWNER/MEMBER）。
- 文件（个人/团队）：上传、统一下载入口 /api/files/{id}、删除（团队文件仅创建者可删）、回收站、标签/目录、版本记录（如启用）。
- 通知中心：事件通知、已读/未读状态，支持扩展邮件或站内信。
- 搜索与过滤：按名称、标签、创建者、时间范围等组合条件。
- 安全与审计：操作日志、异常告警、访问审计，传输/存储加密策略。
- 运维与监控：健康检查、性能指标、告警与容量规划。

## 核心业务流程

- 登录鉴权：前端跳转 Keycloak 登录 → 获取 Token → 调用后端 API（携带 Authorization: Bearer <token>）。
- 文件上传：用户选择个人/团队目标 → 后端落库元数据并持久化文件 → 返回文件 ID 与访问路径。
- 文件下载：通过统一入口 /api/files/{id} 读取权限并流式下发（个人/团队共享一致）。
- 团队共享：创建小组 → 邀请成员（POST /api/groups/{id}/members） → 上传团队文件 → 创建者可删除共享文件（DELETE /api/groups/files/{fileId}）。
- 通知：业务事件写入通知中心，客户端拉取或推送（如配置邮件/站内信）。
- 回收站：删除操作进入回收站（如实现），支持恢复与彻底删除（需后端策略）。

## 数据与权限模型

- 身份来源：Keycloak 用户、组、角色；后端按 Token 校验访问。
- 角色粒度：
	- 系统/平台管理员（可选，跨租户运维）。
	- 团队角色：OWNER（创建者，拥有删除组/共享文件权限）、MEMBER（普通成员）。
- 资源授权：
	- 文件删除（团队）：仅创建者；个人文件由本人操作。
	- 组删除：仅组创建者（DELETE /api/groups/{groupId}）。
	- 下载：凭 Token 校验访问范围与所属关系。
- 审计：记录敏感操作（登录、上传、下载、删除、成员变更）。

## 接口与测试

- API 文档：参见根目录 API.md 与 docs/wiki/API.md（包含团队共享文件删除、成员管理、通用下载等）。
- Postman 集合：postman/Keycloak-Guardians.postman_collection.json。
	- 设置环境变量：access_token，base_url（默认 http://localhost:8081）。
	- 覆盖：文件上传/下载、团队共享文件删除、成员列表/邀请、组删除等。
- 本地运行：
	- 后端：在 keycloak-server/ 执行 ./gradlew quarkusDev 或 gradlew.bat quarkusDev。
	- 前端主题：Theme/ 目录执行 npm install && npm run dev/build，产出 Keycloak 主题资源。

## 非功能与质量

- 性能：大文件上传需分片/断点续传（可后续扩展），下载使用流式响应；关注数据库索引与分页查询。
- 安全：全程 HTTPS，敏感数据脱敏/加密；Token 过期与刷新策略；最小权限原则。
- 可观测：启用健康检查、指标、结构化日志；关键信息打点（上传/下载耗时）。
- 可靠性：定期备份（数据库与对象存储），灾备演练；回收站/版本策略防误删。

## 里程碑计划

- M1：认证打通、个人文件上传/下载、基础小组 CRUD、前端主题首版。
- M2：团队共享文件删除、成员邀请与权限控制、通知中心、搜索基础版。
- M3：审计与安全加固、回收站/版本管理、性能与容量优化、CI/CD 自动化。
- M4（可选）：分片上传、对象存储直传、跨区域冗余、多租户隔离。

## 风险与应对

- 大文件与带宽：限制单次上传大小，必要时分片与直传对象存储；服务端限流与配额管理。
- 权限回归：关键接口覆盖集成测试；删除/下载操作强校验所有权与成员关系。
- 外部依赖：Keycloak/数据库/对象存储不可用时的降级与告警；重试与超时策略。
- 数据一致性：上传元数据与文件持久化需幂等；删除与回收站操作需事务保障。

## 运维与部署要点

- 配置：application.properties 管理端口、数据库、存储、Keycloak 客户端等；区分 dev/prod 配置。
- 部署：容器化优先，建议使用反向代理/网关暴露 API；结合 CI/CD（构建、测试、扫描、发布）。
- 监控：接入日志/指标/告警系统；定期容量评估（存储、连接数、带宽）。

## 开发与协作规范

- 分支策略：feature/bugfix/release，提交信息语义化；PR 需代码评审与自动化检查。
- 代码质量：单元/集成测试覆盖核心权限与文件操作；静态分析与安全扫描（依赖漏洞、许可证）。
- 文档：接口变更同步 API.md、docs/wiki/API.md 与 Postman 集合；架构图与配置示例保持更新。
