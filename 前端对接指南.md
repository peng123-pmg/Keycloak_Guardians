# å‰ç«¯ä¸åç«¯è”è°ƒå¯¹æ¥æŒ‡å—

> **ç¼–å†™äºº**: AIåŠ©æ‰‹  
> **æ¥æ”¶äºº**: ææ¬£å†‰ï¼ˆå‰ç«¯å¼€å‘ï¼‰  
> **æ—¶é—´**: 2025-11-29  
> **ç›®çš„**: è¯´æ˜å¦‚ä½•å°†å½­èŒ‚åˆšå®Œæˆçš„åç«¯APIé›†æˆåˆ°å‰ç«¯é¡µé¢ä¸­

---

## ğŸ“‹ ç›®å½•
1. [åç«¯APIç°çŠ¶](#åç«¯apiç°çŠ¶)
2. [å‰ç«¯ç°æœ‰æ¶æ„](#å‰ç«¯ç°æœ‰æ¶æ„)
3. [éœ€è¦ä½ åšçš„å·¥ä½œ](#éœ€è¦ä½ åšçš„å·¥ä½œ)
4. [è¯¦ç»†å®ç°æ­¥éª¤](#è¯¦ç»†å®ç°æ­¥éª¤)
5. [æµ‹è¯•æ–¹æ³•](#æµ‹è¯•æ–¹æ³•)

---

## ğŸ” åç«¯APIç°çŠ¶

### å·²å®Œæˆçš„APIæ¥å£ï¼ˆåœ¨mainåˆ†æ”¯ï¼‰

æ ¹æ® `API.md` æ–‡æ¡£ï¼Œå½­èŒ‚åˆšå·²å®Œæˆä»¥ä¸‹æ¥å£ï¼š

#### 1. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- **è·¯å¾„**: `/api/users/me`
- **æ–¹æ³•**: `GET`
- **éœ€è¦Token**: âœ… (Authorization: Bearer <access_token>)
- **è¿”å›æ•°æ®**:
```json
{
    "username": "admin",
    "email": "admin@example.com",
    "roles": ["admin", "user"],
    "userId": "b8d3ef6b-09bb-49d2-8829-b23f46778636",
    "welcome": "æ¬¢è¿å›æ¥ï¼Œç®¡ç†å‘˜!"
}
```

#### 2. è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
- **è·¯å¾„**: `/api/user/stats`
- **æ–¹æ³•**: `GET`
- **éœ€è¦Token**: âœ… (éœ€è¦adminè§’è‰²)
- **è¿”å›æ•°æ®**:
```json
{
    "message": "ç”¨æˆ·æ•°æ®æ¦‚è§ˆè·å–æˆåŠŸ",
    "data": {
        "summary": {
            "æ€»ç”¨æˆ·æ•°": 3,
            "æ´»è·ƒç”¨æˆ·": 3,
            "ä»Šæ—¥æ–°å¢": 0
        },
        "roleDistribution": [...],
        "registrationHistory": [...]
    }
}
```

#### 3. åˆ›å»ºç”¨æˆ·
- **è·¯å¾„**: `/api/admin/users`
- **æ–¹æ³•**: `POST`
- **éœ€è¦Token**: âœ… (éœ€è¦adminè§’è‰²)

### åç«¯æœåŠ¡é…ç½®
- **åç«¯æœåŠ¡åœ°å€**: `http://localhost:8081`
- **Keycloakåœ°å€**: `http://localhost:8080`
- **Realm**: `guardians`
- **Client ID**: `backend-service`

---

## ğŸ—ï¸ å‰ç«¯ç°æœ‰æ¶æ„

å¥½æ¶ˆæ¯ï¼**ä½ çš„å‰ç«¯å·²ç»é¢„ç•™äº†å®Œæ•´çš„å¯¹æ¥æ¥å£**ï¼Œåœ¨ `src/services/authService.ts` ä¸­ï¼š

### å½“å‰å·¥ä½œæ¨¡å¼
```typescript
// ç›®å‰ä½¿ç”¨ Mock æ•°æ®ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
const useMock = import.meta.env.VITE_USE_MOCK_AUTH !== 'false'; // é»˜è®¤true
```

### å·²å®ç°çš„MockæœåŠ¡
- âœ… `login()` - ç™»å½•åŠŸèƒ½ï¼ˆMockï¼‰
- âœ… `logout()` - ç™»å‡ºåŠŸèƒ½ï¼ˆMockï¼‰
- âœ… `getCurrentUser()` - è·å–å½“å‰ç”¨æˆ·ï¼ˆMockï¼‰
- âœ… `refreshToken()` - åˆ·æ–°Tokenï¼ˆMockï¼‰
- âœ… `validateToken()` - éªŒè¯Tokenï¼ˆMockï¼‰

### é¢„ç•™çš„çœŸå®APIæ¥å£ï¼ˆéœ€è¦å®ç°ï¼‰
åœ¨ `KeycloakAuthService` ç±»ä¸­ï¼Œæœ‰æ¸…æ™°çš„TODOæ ‡è®°ï¼š

```typescript
class KeycloakAuthService implements IAuthService {
  async login(request: LoginRequest): Promise<LoginResponse> {
    // ğŸ”§ TODO: ç”±å¯¹æ¥åç«¯çš„åŒäº‹å®ç°
    throw new Error('KeycloakAuthService.login() éœ€è¦å®ç°');
  }
  // ... å…¶ä»–æ–¹æ³•åŒæ ·æ ‡è®°ä¸ºTODO
}
```

---

## âœ… éœ€è¦ä½ åšçš„å·¥ä½œ

### æ ¸å¿ƒä»»åŠ¡
**å®ç° `KeycloakAuthService` ç±»ä¸­çš„5ä¸ªæ–¹æ³•ï¼Œå¯¹æ¥å½­èŒ‚åˆšçš„åç«¯API**

ä½ éœ€è¦ï¼š
1. å®ç°çœŸå®çš„APIè°ƒç”¨é€»è¾‘
2. å¤„ç†Tokenå­˜å‚¨å’Œåˆ·æ–°
3. é…ç½®ç¯å¢ƒå˜é‡
4. æµ‹è¯•è”è°ƒæ˜¯å¦æˆåŠŸ

**ä¸éœ€è¦æ”¹åŠ¨UIé¡µé¢** - å› ä¸ºé¡µé¢å·²ç»åœ¨ä½¿ç”¨ `authService`ï¼Œåªéœ€è¦æŠŠåº•å±‚ä»Mockåˆ‡æ¢åˆ°çœŸå®APIå³å¯ã€‚

---

## ğŸ“ è¯¦ç»†å®ç°æ­¥éª¤

### æ­¥éª¤1: å®‰è£…HTTPè¯·æ±‚åº“ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰

```bash
npm install axios
# æˆ–
npm install ky
```

### æ­¥éª¤2: åˆ›å»ºAPIå®¢æˆ·ç«¯å·¥å…·

åˆ›å»ºæ–‡ä»¶ `src/services/apiClient.ts`:

```typescript
import axios from 'axios';

// åˆ›å»ºaxioså®ä¾‹
const apiClient = axios.create({
  baseURL: import.meta.env.VITE_BACKEND_URL || 'http://localhost:8081',
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
  }
});

// è¯·æ±‚æ‹¦æˆªå™¨ - è‡ªåŠ¨æ·»åŠ Token
apiClient.interceptors.request.use(
  (config) => {
    const tokens = localStorage.getItem('authTokens');
    if (tokens) {
      const { accessToken } = JSON.parse(tokens);
      config.headers.Authorization = `Bearer ${accessToken}`;
    }
    return config;
  },
  (error) => Promise.reject(error)
);

// å“åº”æ‹¦æˆªå™¨ - å¤„ç†é”™è¯¯
apiClient.interceptors.response.use(
  (response) => response,
  async (error) => {
    if (error.response?.status === 401) {
      // Tokenè¿‡æœŸï¼Œå°è¯•åˆ·æ–°
      console.warn('Tokenå·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•');
      // å¯ä»¥åœ¨è¿™é‡Œå®ç°è‡ªåŠ¨åˆ·æ–°Tokençš„é€»è¾‘
    }
    return Promise.reject(error);
  }
);

export default apiClient;
```

### æ­¥éª¤3: å®ç° KeycloakAuthService

ä¿®æ”¹ `src/services/authService.ts` ä¸­çš„ `KeycloakAuthService` ç±»ï¼š

```typescript
import apiClient from './apiClient';

class KeycloakAuthService implements IAuthService {
  private config: KeycloakConfig;

  constructor(config: KeycloakConfig) {
    this.config = config;
  }

  async login(request: LoginRequest): Promise<LoginResponse> {
    try {
      // æ­¥éª¤1: ä½¿ç”¨Keycloakè·å–Token
      const tokenResponse = await this.getTokenFromKeycloak(
        request.username, 
        request.password
      );

      // æ­¥éª¤2: ä½¿ç”¨Tokenè·å–ç”¨æˆ·ä¿¡æ¯
      const user = await this.fetchUserInfo(tokenResponse.accessToken);

      // æ­¥éª¤3: ä¿å­˜åˆ°æœ¬åœ°
      this.saveAuthData(user, tokenResponse);

      console.log('âœ… Keycloakç™»å½•æˆåŠŸ:', user);

      return {
        success: true,
        user,
        tokens: tokenResponse,
        message: 'ç™»å½•æˆåŠŸ'
      };
    } catch (error: any) {
      console.error('âŒ ç™»å½•å¤±è´¥:', error);
      return {
        success: false,
        error: error.response?.data?.error || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç '
      };
    }
  }

  async logout(): Promise<void> {
    try {
      const tokens = this.getStoredTokens();
      if (tokens?.refreshToken) {
        // è°ƒç”¨Keycloakç™»å‡ºç«¯ç‚¹
        await axios.post(
          `${this.config.url}/realms/${this.config.realm}/protocol/openid-connect/logout`,
          new URLSearchParams({
            client_id: this.config.clientId,
            refresh_token: tokens.refreshToken
          }),
          {
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
          }
        );
      }
    } catch (error) {
      console.warn('Keycloakç™»å‡ºè¯·æ±‚å¤±è´¥ï¼Œæ¸…é™¤æœ¬åœ°æ•°æ®', error);
    } finally {
      this.clearAuthData();
      console.log('âœ… å·²ç™»å‡º');
    }
  }

  async getCurrentUser(): Promise<User | null> {
    try {
      // æ–¹æ³•1: ä»localStorageè¯»å–ï¼ˆå·²ç¼“å­˜ï¼‰
      const userStr = localStorage.getItem('currentUser');
      if (userStr) {
        return JSON.parse(userStr);
      }

      // æ–¹æ³•2: ä»åç«¯APIè·å–ï¼ˆéœ€è¦æœ‰æ•ˆTokenï¼‰
      const response = await apiClient.get('/api/users/me');
      const userData = response.data;

      const user: User = {
        username: userData.username,
        email: userData.email,
        roles: userData.roles,
        displayName: userData.username
      };

      localStorage.setItem('currentUser', JSON.stringify(user));
      return user;
    } catch (error) {
      console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
      return null;
    }
  }

  async refreshToken(refreshToken: string): Promise<TokenResponse> {
    try {
      const response = await axios.post(
        `${this.config.url}/realms/${this.config.realm}/protocol/openid-connect/token`,
        new URLSearchParams({
          grant_type: 'refresh_token',
          client_id: this.config.clientId,
          refresh_token: refreshToken
        }),
        {
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
        }
      );

      return {
        accessToken: response.data.access_token,
        refreshToken: response.data.refresh_token,
        expiresIn: response.data.expires_in,
        tokenType: 'Bearer'
      };
    } catch (error) {
      console.error('åˆ·æ–°Tokenå¤±è´¥:', error);
      throw new Error('Tokenåˆ·æ–°å¤±è´¥');
    }
  }

  async validateToken(token: string): Promise<boolean> {
    try {
      // æ–¹æ³•1: è°ƒç”¨åç«¯APIéªŒè¯
      await apiClient.get('/api/users/me', {
        headers: { Authorization: `Bearer ${token}` }
      });
      return true;
    } catch {
      return false;
    }
  }

  // ========== ç§æœ‰è¾…åŠ©æ–¹æ³• ==========

  private async getTokenFromKeycloak(
    username: string, 
    password: string
  ): Promise<TokenResponse> {
    const response = await axios.post(
      `${this.config.url}/realms/${this.config.realm}/protocol/openid-connect/token`,
      new URLSearchParams({
        grant_type: 'password',
        client_id: this.config.clientId,
        username: username,
        password: password
      }),
      {
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
      }
    );

    return {
      accessToken: response.data.access_token,
      refreshToken: response.data.refresh_token,
      expiresIn: response.data.expires_in,
      tokenType: 'Bearer'
    };
  }

  private async fetchUserInfo(accessToken: string): Promise<User> {
    const response = await apiClient.get('/api/users/me', {
      headers: { Authorization: `Bearer ${accessToken}` }
    });

    return {
      username: response.data.username,
      email: response.data.email,
      roles: response.data.roles,
      displayName: response.data.username
    };
  }

  private saveAuthData(user: User, tokens: TokenResponse): void {
    localStorage.setItem('currentUser', JSON.stringify(user));
    localStorage.setItem('authTokens', JSON.stringify(tokens));
    localStorage.setItem('loginTime', new Date().toISOString());
  }

  private clearAuthData(): void {
    localStorage.removeItem('currentUser');
    localStorage.removeItem('authTokens');
    localStorage.removeItem('loginTime');
  }

  private getStoredTokens(): TokenResponse | null {
    const tokensStr = localStorage.getItem('authTokens');
    if (!tokensStr) return null;
    try {
      return JSON.parse(tokensStr);
    } catch {
      return null;
    }
  }
}
```

### æ­¥éª¤4: é…ç½®ç¯å¢ƒå˜é‡

ä¿®æ”¹ `.env` æ–‡ä»¶ï¼ˆæˆ–åˆ›å»º `.env.local`ï¼‰:

```env
# åˆ‡æ¢åˆ°çœŸå®APIæ¨¡å¼
VITE_USE_MOCK_AUTH=false

# åç«¯æœåŠ¡åœ°å€
VITE_BACKEND_URL=http://localhost:8081

# Keycloaké…ç½®
VITE_KEYCLOAK_URL=http://localhost:8080
VITE_KEYCLOAK_REALM=guardians
VITE_KEYCLOAK_CLIENT_ID=backend-service
```

### æ­¥éª¤5: åœ¨é¡µé¢ä¸­ä½¿ç”¨ï¼ˆç¤ºä¾‹ï¼‰

ä½ çš„é¡µé¢å·²ç»åœ¨ä½¿ç”¨ `authService`ï¼Œä¸éœ€è¦æ”¹åŠ¨ï¼ä¾‹å¦‚ï¼š

```typescript
// src/pages/Dashboard/Dashboard.tsx (å·²æœ‰ä»£ç ï¼Œæ— éœ€ä¿®æ”¹)
import { authService } from '../../services/authService';

const Dashboard = () => {
  useEffect(() => {
    const loadUser = async () => {
      const user = await authService.getCurrentUser();
      if (user) {
        setCurrentUser(user);
      }
    };
    loadUser();
  }, []);
  
  // ... å…¶ä»–ä»£ç 
};
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨åç«¯æœåŠ¡**
   ```bash
   # åœ¨åç«¯é¡¹ç›®ç›®å½•
   cd keycloak-server
   ./gradlew quarkusDev
   # åç«¯å°†è¿è¡Œåœ¨ http://localhost:8081
   ```

2. **ç¡®ä¿Keycloakè¿è¡Œ**
   ```bash
   # Keycloakåº”è¯¥è¿è¡Œåœ¨ http://localhost:8080
   ```

3. **ä¿®æ”¹ç¯å¢ƒå˜é‡**
   ```env
   VITE_USE_MOCK_AUTH=false
   ```

4. **å¯åŠ¨å‰ç«¯**
   ```bash
   npm run dev
   ```

5. **æµ‹è¯•ç™»å½•**
   - ä½¿ç”¨ä»¥ä¸‹è´¦å·æµ‹è¯•:
     - ç”¨æˆ·å: `admin`
     - å¯†ç : `admin` (æˆ–æ ¹æ®åç«¯é…ç½®çš„å¯†ç )

6. **æ£€æŸ¥æ§åˆ¶å°**
   - åº”è¯¥çœ‹åˆ°: `ğŸ” ä½¿ç”¨ Keycloak è®¤è¯æœåŠ¡ (ç”Ÿäº§æ¨¡å¼)`
   - ç™»å½•æˆåŠŸå: `âœ… Keycloakç™»å½•æˆåŠŸ: {userå¯¹è±¡}`

### å¸¸è§é—®é¢˜æ’æŸ¥

| é—®é¢˜ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ³• |
|------|---------|---------|
| è·¨åŸŸé”™è¯¯ (CORS) | åç«¯æœªé…ç½®CORS | æ£€æŸ¥åç«¯ `application.properties` ä¸­çš„ `quarkus.http.cors.origins` |
| 401 æœªæˆæƒ | Tokenæ— æ•ˆæˆ–è¿‡æœŸ | æ£€æŸ¥Tokenæ˜¯å¦æ­£ç¡®ä¼ é€’ï¼ŒæŸ¥çœ‹æµè§ˆå™¨Networké¢æ¿ |
| 404 æ¥å£ä¸å­˜åœ¨ | åç«¯æœåŠ¡æœªå¯åŠ¨æˆ–è·¯å¾„é”™è¯¯ | ç¡®è®¤åç«¯è¿è¡Œåœ¨8081ç«¯å£ï¼Œæ£€æŸ¥APIè·¯å¾„ |
| Connection refused | åç«¯æœªå¯åŠ¨ | å¯åŠ¨åç«¯æœåŠ¡ |

---

## ğŸ“Œ æ€»ç»“

### ä½ éœ€è¦åšçš„äº‹æƒ…ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰:

1. âœ… **é˜…è¯»ç†è§£**: ç†è§£åç«¯APIçš„å·¥ä½œæ–¹å¼ï¼ˆå·²æä¾›æ–‡æ¡£ï¼‰
2. âœ… **å®‰è£…ä¾èµ–**: `npm install axios`
3. âœ… **åˆ›å»ºæ–‡ä»¶**: `src/services/apiClient.ts`
4. âœ… **å®ç°æ–¹æ³•**: å®Œæˆ `KeycloakAuthService` çš„5ä¸ªæ–¹æ³•
5. âœ… **é…ç½®ç¯å¢ƒ**: ä¿®æ”¹ `.env` æ–‡ä»¶
6. âœ… **è”è°ƒæµ‹è¯•**: ä¸å½­èŒ‚åˆšä¸€èµ·æµ‹è¯•ç™»å½•æµç¨‹

### ä¸éœ€è¦åšçš„äº‹æƒ…:

- âŒ ä¸éœ€è¦æ”¹åŠ¨ä»»ä½•UIé¡µé¢ä»£ç 
- âŒ ä¸éœ€è¦ä¿®æ”¹è·¯ç”±
- âŒ ä¸éœ€è¦æ”¹å˜ç»„ä»¶ç»“æ„

### åä½œå»ºè®®:

1. **ä¸å½­èŒ‚åˆšæ²Ÿé€š**:
   - ç¡®è®¤åç«¯æœåŠ¡æ˜¯å¦å·²éƒ¨ç½²
   - ç¡®è®¤æµ‹è¯•è´¦å·å’Œå¯†ç 
   - ç¡®è®¤APIç«¯ç‚¹æ˜¯å¦æœ‰å˜åŒ–

2. **åˆ†é˜¶æ®µæµ‹è¯•**:
   - å…ˆæµ‹è¯•ç™»å½•åŠŸèƒ½
   - å†æµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯
   - æœ€åæµ‹è¯•ç™»å‡ºå’ŒTokenåˆ·æ–°

3. **ä¿ç•™Mockæ¨¡å¼**:
   - åœ¨ `.env` ä¸­ä¿ç•™Mockå¼€å…³
   - åç«¯æœåŠ¡ä¸å¯ç”¨æ—¶å¯ä»¥å¿«é€Ÿåˆ‡å›Mockæ¨¡å¼

---

å¦‚æœ‰ç–‘é—®ï¼Œå¯ä»¥å‚è€ƒ:
- APIæ–‡æ¡£: `API.md`
- åç«¯ä»£ç : `keycloak-server/src/main/kotlin/com/example/resources/`
- ç±»å‹å®šä¹‰: `src/services/types.ts`
