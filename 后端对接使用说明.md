# åç«¯å¯¹æ¥ä½¿ç”¨è¯´æ˜

> **å®ç°å®Œæˆæ—¥æœŸ**: 2025-11-29  
> **å®ç°äºº**: AIåŠ©æ‰‹  
> **é€‚ç”¨äºº**: ææ¬£å†‰ï¼ˆå‰ç«¯å¼€å‘ï¼‰

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. å®‰è£…ä¾èµ–
å·²åœ¨ `package.json` ä¸­æ·»åŠ  `axios` ä¾èµ–ï¼š
```json
"axios": "^1.6.0"
```

**éœ€è¦æ‰§è¡Œ**: 
```bash
npm install
```

### 2. åˆ›å»ºçš„æ–‡ä»¶

#### æ ¸å¿ƒæ–‡ä»¶ï¼š
- âœ… `src/services/apiClient.ts` - HTTPè¯·æ±‚å®¢æˆ·ç«¯ï¼ˆè‡ªåŠ¨å¤„ç†Tokenã€é”™è¯¯ï¼‰
- âœ… `src/services/authService.ts` - è®¤è¯æœåŠ¡ï¼ˆå·²å®ç°å®Œæ•´çš„Keycloakå¯¹æ¥ï¼‰
- âœ… `src/services/userService.ts` - ç”¨æˆ·APIæœåŠ¡ï¼ˆå°è£…åç«¯APIè°ƒç”¨ï¼‰
- âœ… `src/services/authUtils.ts` - è®¤è¯å·¥å…·å‡½æ•°ï¼ˆè¾…åŠ©åŠŸèƒ½ï¼‰

#### é…ç½®æ–‡ä»¶ï¼š
- âœ… `.env` - å¼€å‘ç¯å¢ƒé…ç½®ï¼ˆé»˜è®¤ä½¿ç”¨Mockï¼‰
- âœ… `.env.production` - ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ˆä½¿ç”¨çœŸå®APIï¼‰

---

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### æ–¹å¼1: ç»§ç»­ä½¿ç”¨Mockæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
```env
# .env
VITE_USE_MOCK_AUTH=true
```

**é€‚ç”¨åœºæ™¯**: 
- åç«¯æœåŠ¡æœªå¯åŠ¨
- å¿«é€Ÿå¼€å‘UI
- ä¸éœ€è¦çœŸå®æ•°æ®

### æ–¹å¼2: åˆ‡æ¢åˆ°çœŸå®APIæ¨¡å¼

#### Step 1: ä¿®æ”¹ç¯å¢ƒå˜é‡
```env
# .env
VITE_USE_MOCK_AUTH=false
VITE_BACKEND_URL=http://localhost:8081
VITE_KEYCLOAK_URL=http://localhost:8080
VITE_KEYCLOAK_REALM=guardians
VITE_KEYCLOAK_CLIENT_ID=backend-service
```

#### Step 2: ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œ
```bash
# è¿›å…¥åç«¯é¡¹ç›®ç›®å½•
cd keycloak-server

# å¯åŠ¨åç«¯æœåŠ¡
./gradlew quarkusDev

# æˆ–åœ¨Windowsä¸Š
gradlew.bat quarkusDev
```

åç«¯æœåŠ¡åº”è¯¥è¿è¡Œåœ¨: `http://localhost:8081`

#### Step 3: ç¡®ä¿Keycloakè¿è¡Œ
Keycloakåº”è¯¥è¿è¡Œåœ¨: `http://localhost:8080`

#### Step 4: é‡å¯å‰ç«¯æœåŠ¡
```bash
npm run dev
```

#### Step 5: æµ‹è¯•ç™»å½•
ä½¿ç”¨ä»¥ä¸‹æµ‹è¯•è´¦å·ï¼š
- ç”¨æˆ·å: `admin`
- å¯†ç : `admin`ï¼ˆæˆ–æ ¹æ®Keycloaké…ç½®ï¼‰

---

## ğŸ“– ä»£ç ç¤ºä¾‹

### åœ¨é¡µé¢ä¸­ä½¿ç”¨è®¤è¯æœåŠ¡

```typescript
import { authService } from '@/services/authService';
import { userService } from '@/services/userService';
import { isAuthenticated, hasRole } from '@/services/authUtils';

// 1. ç™»å½•
const handleLogin = async () => {
  const result = await authService.login({
    username: 'admin',
    password: 'admin123'
  });

  if (result.success) {
    console.log('ç™»å½•æˆåŠŸ:', result.user);
    // è·³è½¬åˆ°ä¸»é¡µ
    navigate('/dashboard');
  } else {
    console.error('ç™»å½•å¤±è´¥:', result.error);
  }
};

// 2. è·å–å½“å‰ç”¨æˆ·
const loadUser = async () => {
  const user = await authService.getCurrentUser();
  if (user) {
    console.log('å½“å‰ç”¨æˆ·:', user);
  }
};

// 3. æ£€æŸ¥æ˜¯å¦ç™»å½•
if (isAuthenticated()) {
  console.log('ç”¨æˆ·å·²ç™»å½•');
}

// 4. æ£€æŸ¥æƒé™
if (hasRole('admin')) {
  console.log('ç”¨æˆ·æ˜¯ç®¡ç†å‘˜');
}

// 5. è·å–ç”¨æˆ·ç»Ÿè®¡æ•°æ®ï¼ˆéœ€è¦adminæƒé™ï¼‰
const loadStats = async () => {
  try {
    const stats = await userService.getUserStats();
    console.log('ç”¨æˆ·ç»Ÿè®¡:', stats);
  } catch (error) {
    console.error('è·å–ç»Ÿè®¡å¤±è´¥:', error);
  }
};

// 6. ç™»å‡º
const handleLogout = async () => {
  await authService.logout();
  navigate('/login');
};
```

### ä½¿ç”¨APIå®¢æˆ·ç«¯è°ƒç”¨å…¶ä»–æ¥å£

```typescript
import apiClient from '@/services/apiClient';

// GETè¯·æ±‚
const response = await apiClient.get('/api/some-endpoint');

// POSTè¯·æ±‚
const response = await apiClient.post('/api/some-endpoint', {
  data: 'value'
});

// è‡ªåŠ¨æºå¸¦Tokenï¼Œæ— éœ€æ‰‹åŠ¨æ·»åŠ 
```

---

## ğŸ”§ åŠŸèƒ½ç‰¹æ€§

### 1. è‡ªåŠ¨Tokenç®¡ç†
- âœ… ç™»å½•æ—¶è‡ªåŠ¨ä¿å­˜Token
- âœ… è¯·æ±‚æ—¶è‡ªåŠ¨æ·»åŠ Authorizationå¤´
- âœ… Tokenè¿‡æœŸè‡ªåŠ¨æ¸…é™¤
- âœ… æ”¯æŒTokenåˆ·æ–°

### 2. é”™è¯¯å¤„ç†
- âœ… 401 æœªæˆæƒ â†’ è‡ªåŠ¨æ¸…é™¤Tokenå¹¶æç¤ºé‡æ–°ç™»å½•
- âœ… 403 æƒé™ä¸è¶³ â†’ æç¤ºæƒé™ä¸è¶³
- âœ… 404 èµ„æºä¸å­˜åœ¨ â†’ æç¤ºèµ„æºä¸å­˜åœ¨
- âœ… 500 æœåŠ¡å™¨é”™è¯¯ â†’ æç¤ºæœåŠ¡å™¨é”™è¯¯
- âœ… ç½‘ç»œé”™è¯¯ â†’ æç¤ºç½‘ç»œè¿æ¥å¤±è´¥

### 3. æ—¥å¿—è¾“å‡º
```
ğŸ” å¼€å§‹Keycloakç™»å½•æµç¨‹...
âœ… Tokenè·å–æˆåŠŸ
âœ… ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ: {username: "admin", ...}
âœ… ç™»å½•æˆåŠŸ
```

### 4. æœ¬åœ°å­˜å‚¨
- `currentUser` - ç”¨æˆ·ä¿¡æ¯
- `authTokens` - Tokenä¿¡æ¯
- `loginTime` - ç™»å½•æ—¶é—´

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯•Mockæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
```bash
# 1. å¯åŠ¨å‰ç«¯
npm run dev

# 2. è®¿é—® http://localhost:5173
# 3. ä½¿ç”¨Mockè´¦å·ç™»å½•:
#    - admin / 123456
#    - alice / alice
#    - jdoe / jdoe

# 4. æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º:
#    ğŸ”§ ä½¿ç”¨ Mock è®¤è¯æœåŠ¡ (å¼€å‘æ¨¡å¼)
#    âœ… Mockç™»å½•æˆåŠŸ: admin
```

### 2. æµ‹è¯•çœŸå®APIæ¨¡å¼

#### å‰ç½®æ¡ä»¶æ£€æŸ¥ï¼š
```bash
# æ£€æŸ¥Keycloakæ˜¯å¦è¿è¡Œ
curl http://localhost:8080

# æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
curl http://localhost:8081/health
```

#### æµ‹è¯•æµç¨‹ï¼š
```bash
# 1. ä¿®æ”¹ .env
VITE_USE_MOCK_AUTH=false

# 2. é‡å¯å‰ç«¯
npm run dev

# 3. æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º:
#    ğŸ” ä½¿ç”¨ Keycloak è®¤è¯æœåŠ¡ (ç”Ÿäº§æ¨¡å¼)

# 4. ç™»å½•æµ‹è¯•
#    - ä½¿ç”¨Keycloakä¸­é…ç½®çš„çœŸå®ç”¨æˆ·
#    - æŸ¥çœ‹Networké¢æ¿ï¼Œåº”è¯¥çœ‹åˆ°:
#      POST http://localhost:8080/realms/guardians/protocol/openid-connect/token
#      GET http://localhost:8081/api/users/me

# 5. æˆåŠŸæ ‡å¿—:
#    âœ… Tokenè·å–æˆåŠŸ
#    âœ… ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ
#    âœ… ç™»å½•æˆåŠŸ
```

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡
**é”™è¯¯ä¿¡æ¯**: `ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨`

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨: `curl http://localhost:8081/health`
2. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
3. æŸ¥çœ‹åç«¯æœåŠ¡æ—¥å¿—

### é—®é¢˜2: CORSè·¨åŸŸé”™è¯¯
**é”™è¯¯ä¿¡æ¯**: `Access-Control-Allow-Origin`

**è§£å†³æ–¹æ³•**:
åç«¯å·²é…ç½®CORSï¼Œæ£€æŸ¥ `keycloak-server/src/main/resources/application.properties`:
```properties
quarkus.http.cors=true
quarkus.http.cors.origins=*
```

### é—®é¢˜3: TokenéªŒè¯å¤±è´¥
**é”™è¯¯ä¿¡æ¯**: `401 Unauthorized`

**è§£å†³æ–¹æ³•**:
1. ç¡®è®¤Keycloaké…ç½®æ­£ç¡®
2. æ£€æŸ¥Realmåç§°æ˜¯å¦ä¸º `guardians`
3. æ£€æŸ¥Client IDæ˜¯å¦ä¸º `backend-service`
4. æŸ¥çœ‹æµè§ˆå™¨Networké¢æ¿ï¼Œç¡®è®¤Tokenæ ¼å¼

### é—®é¢˜4: ç”¨æˆ·åå¯†ç é”™è¯¯
**é”™è¯¯ä¿¡æ¯**: `ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯`

**è§£å†³æ–¹æ³•**:
1. ç¡®è®¤ä½¿ç”¨Keycloakä¸­é…ç½®çš„ç”¨æˆ·
2. æ£€æŸ¥Keycloakç”¨æˆ·ç®¡ç†ç•Œé¢
3. é‡ç½®ç”¨æˆ·å¯†ç 

---

## ğŸ“Š è°ƒè¯•å·¥å…·

### åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è°ƒè¯•ï¼š

```javascript
// 1. æŸ¥çœ‹è®¤è¯æ‘˜è¦
import { getAuthSummary } from './services/authUtils';
console.log(getAuthSummary());

// è¾“å‡º:
// {
//   isAuthenticated: true,
//   authMode: 'keycloak',
//   user: { username: 'admin', email: '...', roles: ['admin', 'user'] },
//   hasToken: true,
//   loginTime: '2025-11-29 10:30:00',
//   isTokenExpiring: false
// }

// 2. æŸ¥çœ‹Token
console.log(localStorage.getItem('authTokens'));

// 3. æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯
console.log(localStorage.getItem('currentUser'));

// 4. æ‰‹åŠ¨æµ‹è¯•API
import apiClient from './services/apiClient';
apiClient.get('/api/users/me').then(console.log);
```

---

## ğŸ“š APIæ¥å£æ–‡æ¡£

### åç«¯æä¾›çš„APIï¼ˆå·²å¯¹æ¥ï¼‰

#### 1. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
```
GET /api/users/me
Authorization: Bearer <access_token>

Response:
{
  "username": "admin",
  "email": "admin@example.com",
  "roles": ["admin", "user"],
  "userId": "xxx",
  "welcome": "æ¬¢è¿å›æ¥ï¼Œç®¡ç†å‘˜!"
}
```

#### 2. è·å–ç”¨æˆ·ç»Ÿè®¡ï¼ˆéœ€è¦adminæƒé™ï¼‰
```
GET /api/user/stats
Authorization: Bearer <access_token>

Response:
{
  "message": "ç”¨æˆ·æ•°æ®æ¦‚è§ˆè·å–æˆåŠŸ",
  "data": {
    "summary": { ... },
    "roleDistribution": [ ... ],
    "registrationHistory": [ ... ]
  }
}
```

#### 3. åˆ›å»ºç”¨æˆ·ï¼ˆéœ€è¦adminæƒé™ï¼‰
```
POST /api/admin/users
Authorization: Bearer <access_token>
Content-Type: application/json

Body:
{
  "username": "newuser",
  "email": "user@example.com",
  "enabled": true,
  "roles": ["user"]
}
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥å·¥ä½œå»ºè®®

### å¦‚æœéœ€è¦æ‰©å±•åŠŸèƒ½ï¼š

1. **æ·»åŠ æ–°çš„APIæ¥å£**
   - åœ¨ `src/services/userService.ts` ä¸­æ·»åŠ æ–°æ–¹æ³•
   - ä½¿ç”¨ `apiClient` å‘èµ·è¯·æ±‚

2. **æ·»åŠ æ›´å¤šé”™è¯¯å¤„ç†**
   - åœ¨ `apiClient.ts` ä¸­æ‰©å±•å“åº”æ‹¦æˆªå™¨

3. **å®ç°Tokenè‡ªåŠ¨åˆ·æ–°**
   - åœ¨401é”™è¯¯å¤„ç†ä¸­è°ƒç”¨ `authService.refreshToken()`

4. **æ·»åŠ è¯·æ±‚é‡è¯•æœºåˆ¶**
   - ä½¿ç”¨ `axios-retry` åº“

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š
1. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—
2. æŸ¥çœ‹æµè§ˆå™¨Networké¢æ¿
3. æŸ¥çœ‹åç«¯æœåŠ¡æ—¥å¿—
4. å‚è€ƒæœ¬æ–‡æ¡£çš„"å¸¸è§é—®é¢˜æ’æŸ¥"éƒ¨åˆ†

---

## âœ¨ æ€»ç»“

å·²ç»ä¸ºä½ å®Œæˆï¼š
- âœ… å®Œæ•´çš„Keycloakè®¤è¯å¯¹æ¥
- âœ… è‡ªåŠ¨Tokenç®¡ç†
- âœ… ç»Ÿä¸€çš„APIå®¢æˆ·ç«¯
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†
- âœ… Mock/çœŸå®APIåˆ‡æ¢
- âœ… è°ƒè¯•å·¥å…·å’Œæ—¥å¿—

ä½ åªéœ€è¦ï¼š
1. è¿è¡Œ `npm install` å®‰è£…ä¾èµ–
2. æ ¹æ®éœ€è¦ä¿®æ”¹ `.env` åˆ‡æ¢æ¨¡å¼
3. **ç»§ç»­å¼€å‘UIé¡µé¢ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰é¡µé¢ä»£ç **

æ‰€æœ‰é¡µé¢å·²ç»åœ¨ä½¿ç”¨ `authService`ï¼Œåº•å±‚è‡ªåŠ¨åˆ‡æ¢Mock/çœŸå®APIï¼
